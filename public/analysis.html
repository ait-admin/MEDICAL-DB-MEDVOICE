<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Conversation Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(120deg, #e0eafc 0%, #cfdef3 100%);
            color: #212529; 
            min-height: 100vh; 
        }
        .container {
            max-width: 540px;
            margin-top: 2rem;
            margin-bottom: 2rem;
            margin-left: 250px;
            margin-right: 0;
            width: 100%;
            background: none;
            padding: 0;
        }
        @media (max-width: 992px) {
            .container {
                margin-left: 0;
                max-width: 100%;
                padding: 0 0.5rem;
            }
        }
        .card {
            margin-top: 0;
            margin-bottom: 0;
            max-width: 540px;
            width: 100%;
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18), 0 2px 24px 0 rgba(78,84,200,0.10);
            background: rgba(255,255,255,0.95);
            border: none;
            overflow: hidden;
        }
        .card-header { background-color: #0d6efd; color: white; font-weight: bold; padding: 1.25rem; border-bottom: none; border-radius: 18px 18px 0 0; box-shadow: 0 2px 8px rgba(78,84,200,0.08); }
        .btn-primary { background-color: #0d6efd; border-color: #0d6efd; padding: 0.75rem 1.5rem; font-weight: 500; margin: 0.5rem; }
        .btn-primary:hover { background-color: #0b5ed7; border-color: #0b5ed7; }
        .btn-outline-primary { color: #0d6efd; border-color: #0d6efd; padding: 0.75rem 1.5rem; font-weight: 500; margin: 0.5rem; }
        .btn-outline-primary:hover { background-color: #0d6efd; color: white; }
        .result-label { font-weight: 500; color: #0d6efd; }
        .result-value { font-weight: 500; }
        .placeholder { color: #adb5bd; }
        .result-content { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        @media (max-width: 768px) { .container { max-width: 100%; padding: 0 0.5rem; } .btn { width: 100%; margin: 0.5rem 0; } }
    </style>
</head>
<body>
<div class="container">
    <div class="card shadow-lg">
        
        <div class="card-body">
            <form id="uploadForm" autocomplete="off">
                <div class="mb-4 text-center">
                    <button id="fileInputBtn" type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="tooltip" title="Upload a PDF or TXT file">
                        <i class="bi bi-upload"></i> Choose PDF or TXT File
                    </button>
                    <input type="file" id="fileInput" accept=".pdf,.txt" style="display:none;">
                    <div class="file-name mt-2" id="fileName">No file selected</div>
                </div>
                <div class="d-flex justify-content-center gap-2 mb-3">
                    <button id="analyzeBtn" class="btn btn-primary" type="button" disabled data-bs-toggle="tooltip" title="Analyze the uploaded conversation"><i class="bi bi-search"></i> Analyze Conversation</button>
                    <button id="resetBtn" class="btn btn-outline-primary" type="button" data-bs-toggle="tooltip" title="Reset form and results"><i class="bi bi-arrow-clockwise"></i> Reset</button>
                </div>
            </form>
            <div class="error alert alert-danger d-none" id="errorMessage" role="alert"></div>
            <div class="loading text-center" id="loadingIndicator" style="display:none;">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                <p class="mt-2">Analyzing document...</p>
            </div>
            <div class="result-section mt-4" id="resultSection" style="display:none;">
                <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                    <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#resultContent" aria-expanded="true" aria-controls="resultContent">
                        <i class="bi bi-chevron-down"></i> Show/Hide Analysis Results
                    </button>
                    <button id="downloadBtn" class="btn btn-outline-primary ms-auto" type="button" data-bs-toggle="tooltip" title="Download analysis as PDF" disabled>
                        <i class="bi bi-download"></i> Download
                    </button>
                </div>
                <div class="collapse show" id="resultContent">
                    <div class="result-content p-4">
                        <div class="result-item mb-2"><span class="result-label">Patient Name:</span> <span class="result-value placeholder" id="patientName">---------------</span></div>
                        <div class="result-item mb-2"><span class="result-label">Age:</span> <span class="result-value placeholder" id="patientAge">---------------</span></div>
                        <div class="result-item mb-2"><span class="result-label">Symptoms:</span> <span class="result-value placeholder" id="patientSymptoms">---------------</span></div>
                        <div class="result-item mb-2"><span class="result-label">Diagnosis:</span> <span class="result-value placeholder" id="patientDiagnosis">---------------</span></div>
                        <div class="result-item mb-2"><span class="result-label">Prescribed Medication:</span> <span class="result-value placeholder" id="patientMedication">---------------</span></div>
                        <div class="result-item mb-2"><span class="result-label">Follow-up Date:</span> <span class="result-value placeholder" id="patientFollowup">---------------</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script>
// Initialize PDF.js worker
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

const fileInput = document.getElementById('fileInput');
const fileInputBtn = document.getElementById('fileInputBtn');
const fileNameDisplay = document.getElementById('fileName');
const analyzeBtn = document.getElementById('analyzeBtn');
const resetBtn = document.getElementById('resetBtn');
const loadingIndicator = document.getElementById('loadingIndicator');
const resultSection = document.getElementById('resultSection');
const downloadBtn = document.getElementById('downloadBtn');
const errorMessage = document.getElementById('errorMessage');
const patientName = document.getElementById('patientName');
const patientAge = document.getElementById('patientAge');
const patientSymptoms = document.getElementById('patientSymptoms');
const patientDiagnosis = document.getElementById('patientDiagnosis');
const patientMedication = document.getElementById('patientMedication');
const patientFollowup = document.getElementById('patientFollowup');

// Initialize tooltips
document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

// Make file input accessible via button click
fileInputBtn.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        fileNameDisplay.textContent = file.name;
        analyzeBtn.disabled = false;
    } else {
        fileNameDisplay.textContent = 'No file selected';
        analyzeBtn.disabled = true;
    }
    errorMessage.classList.add('d-none');
    resetPlaceholders();
    resultSection.style.display = 'none';
    downloadBtn.disabled = true;
});

resetBtn.addEventListener('click', () => {
    document.getElementById('uploadForm').reset();
    fileNameDisplay.textContent = 'No file selected';
    analyzeBtn.disabled = true;
    errorMessage.classList.add('d-none');
    resetPlaceholders();
    resultSection.style.display = 'none';
    downloadBtn.disabled = true;
});

function resetPlaceholders() {
    patientName.textContent = '---------------';
    patientName.className = 'result-value placeholder';
    patientAge.textContent = '---------------';
    patientAge.className = 'result-value placeholder';
    patientSymptoms.textContent = '---------------';
    patientSymptoms.className = 'result-value placeholder';
    patientDiagnosis.textContent = '---------------';
    patientDiagnosis.className = 'result-value placeholder';
    patientMedication.textContent = '---------------';
    patientMedication.className = 'result-value placeholder';
    patientFollowup.textContent = '---------------';
    patientFollowup.className = 'result-value placeholder';
}

analyzeBtn.addEventListener('click', async () => {
    const file = fileInput.files[0];
    if (!file) return;
    
    loadingIndicator.style.display = 'block';
    analyzeBtn.disabled = true;
    errorMessage.classList.add('d-none');
    resultSection.style.display = 'none';
    downloadBtn.disabled = true;
    
    try {
        // Replace with your actual API key
        const GOOGLE_API_KEY = "AIzaSyBiGoasPRw9lFXTky62csBkt9Q3ANRmuec";
        if (!GOOGLE_API_KEY) throw new Error("API key not configured");
        
        const text = await extractTextFromFile(file);
        if (!text.trim()) throw new Error('The file appears to be empty or could not be read');
        
        const extractedData = await analyzeWithGemini(text, GOOGLE_API_KEY);
        parseAndDisplayResults(extractedData);
        
        resultSection.style.display = 'block';
        downloadBtn.disabled = false;
        setTimeout(() => { 
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
        }, 200);
        
        downloadBtn.onclick = () => downloadAsPDF(extractedData, file.name.replace(/\.[^/.]+$/, '') + '_analysis.pdf');
    } catch (error) {
        console.error('Analysis error:', error);
        errorMessage.textContent = error.message || 'An error occurred during analysis';
        errorMessage.classList.remove('d-none');
        resetPlaceholders();
    } finally {
        loadingIndicator.style.display = 'none';
        analyzeBtn.disabled = false;
    }
});

function parseAndDisplayResults(text) {
    // Clear previous results
    resetPlaceholders();
    
    // Improved parsing logic
    const resultMap = {
        'Patient Name': patientName,
        'Age': patientAge,
        'Symptoms': patientSymptoms,
        'Diagnosis': patientDiagnosis,
        'Prescribed Medication': patientMedication,
        'Follow-up Date': patientFollowup
    };
    
    const lines = text.split('\n');
    lines.forEach(line => {
        for (const [key, element] of Object.entries(resultMap)) {
            if (line.startsWith(key + ':')) {
                const value = line.substring(key.length + 1).trim();
                element.textContent = value || 'Not specified';
                element.className = 'result-value';
                break;
            }
        }
    });
}

async function extractTextFromFile(file) {
    if (file.name.endsWith('.pdf')) {
        return await extractTextFromPDF(file);
    } else if (file.name.endsWith('.txt')) {
        return await file.text();
    }
    throw new Error('Unsupported file type');
}

async function extractTextFromPDF(file) {
    try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let text = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(item => item.str).join(' ') + '\n';
        }
        
        return text;
    } catch (error) {
        console.error('PDF extraction error:', error);
        throw new Error('Failed to extract text from PDF');
    }
}

async function analyzeWithGemini(text, apiKey) {
    try {
        const promptText = `Analyze this doctor-patient conversation and extract the following information:
- Patient Name
- Age
- Symptoms
- Diagnosis
- Prescribed Medication
- Follow-up Date

Format the response exactly like this:
Patient Name: [name]
Age: [age]
Symptoms: [symptoms]
Diagnosis: [diagnosis]
Prescribed Medication: [medication]
Follow-up Date: [date]

Conversation:
${text.substring(0, 10000)}`; // Limit to first 10,000 chars

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: promptText
                    }]
                }]
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'API request failed');
        }

        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || 'No analysis results found';
    } catch (error) {
        console.error('Gemini API error:', error);
        throw new Error('Failed to analyze with Gemini API: ' + (error.message || 'Unknown error'));
    }
}

function downloadAsPDF(content, filename) {
    // Load jsPDF only when needed
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    script.onload = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Split content into lines and add to PDF
        const lines = doc.splitTextToSize(content, 180);
        let y = 20;
        
        doc.setFontSize(16);
        doc.text('Medical Conversation Analysis', 105, 15, { align: 'center' });
        doc.setFontSize(12);
        
        for (let i = 0; i < lines.length; i++) {
            if (y > 280) {
                doc.addPage();
                y = 20;
            }
            doc.text(lines[i], 15, y);
            y += 7;
        }
        
        doc.save(filename);
    };
    script.onerror = () => {
        alert('Failed to load PDF generator. Please try again.');
    };
    document.head.appendChild(script);
}
</script>
</body>
</html>